<?xml version="1.0" encoding="utf-8"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">

    <!-- Mathematical Constants -->
    <xacro:property name="PI" value="3.1415926535897931" />

    <!-- Macro for da Vinci Patient Side Manipulator (PSM) Base -->
    <xacro:macro name="psm_base" params="prefix parent_link xyz rpy">

        <!-- Link 0: PSM Base Link -->
        <link name="${prefix}_psm_base_link">
            <visual>
                <origin rpy="${PI/2} 0 ${PI}" xyz="0.039 -0.40788 -0.07879" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/psm_base.stl" />
                </geometry>
            </visual>
            <collision>
                <origin rpy="${PI/2} 0 ${PI}" xyz="0.039 -0.40788 -0.07879" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/psm_base.stl" />
                </geometry>
            </collision>
        </link>

        <!-- Link 1: Outer Yaw Link -->
        <link name="${prefix}_outer_yaw_link">
            <visual>
                <!-- <origin rpy="0 0 -${PI/2}" xyz="0.0125 0 0.1575"/> -->
                <origin rpy="${PI} 0 ${PI/2}" xyz="0.0125 0 0.5265" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/outer_yaw.stl" />
                </geometry>
            </visual>
            <collision>
                <!-- <origin rpy="0 0 -${PI/2}" xyz="0.0125 0 0.1575"/> -->
                <origin rpy="${PI} 0 ${PI/2}" xyz="0.0125 0 0.5265" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/outer_yaw.stl" />
                </geometry>
            </collision>
        </link>

        <!-- Link 2: Outer Pitch Link -->
        <link name="${prefix}_outer_pitch_link"/>

        <!-- Link 2-1: Outer Pitch Back Link -->
        <link name="${prefix}_outer_pitch_back_link">
            <visual>
                <origin rpy="0 0 -0.27129" xyz="0 0 0" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/outer_pitch_back.stl" />
                </geometry>
            </visual>
            <collision>
                <origin rpy="0 0 -0.27129" xyz="0 0 0" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/outer_pitch_back.stl" />
                </geometry>
            </collision>
        </link>

        <!-- Link 2-2: Outer Pitch Front Link -->
        <link name="${prefix}_outer_pitch_front_link">
            <visual>
                <origin rpy="0 0 -0.27129" xyz="0 0 0" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/outer_pitch_front.stl" />
                </geometry>
            </visual>
            <collision>
                <origin rpy="0 0 -0.27129" xyz="0 0 0" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/outer_pitch_front.stl" />
                </geometry>
            </collision>
        </link>

        <!-- Link 2-3: Outer Pitch Bottom Link -->
        <link name="${prefix}_outer_pitch_bottom_link">
            <visual>
                <origin rpy="0 -${PI/2} 0" xyz="0.009 0 0" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/outer_pitch_bottom.stl" />
                </geometry>
            </visual>
            <collision>
                <origin rpy="0 -${PI/2} 0" xyz="0.009 0 0" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/outer_pitch_bottom.stl" />
                </geometry>
            </collision>
        </link>

        <!-- Link 2-4: Outer Pitch Top Link -->
        <link name="${prefix}_outer_pitch_top_link">
            <visual>
                <origin rpy="0 -${PI/2} 0" xyz="0.009 0 0" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/outer_pitch_top.stl" />
                </geometry>
            </visual>
            <collision>
                <origin rpy="0 -${PI/2} 0" xyz="0.009 0 0" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/outer_pitch_top.stl" />
                </geometry>
            </collision>
        </link>

        <!-- Link 2-5: Outer Insertion Link -->
        <link name="${prefix}_outer_insertion_link">
            <visual>
                <origin rpy="0 -${PI/2} ${PI/2}" xyz="0.02528 0.429 0" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/outer_insertion.stl" />
                </geometry>
            </visual>
            <collision>
                <origin rpy="0 -${PI/2} ${PI/2}" xyz="0.02528 0.429 0" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/outer_insertion.stl" />
                </geometry>
            </collision>
        </link>

        <!-- Link 3: Tool Main Link -->
        <link name="${prefix}_tool_main_link">
            <visual>
                <origin rpy="0 0 ${PI/2}" xyz="0 0 0.041" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/tool_main.stl" />
                </geometry>
            </visual>
            <collision>
                <origin rpy="0 0 ${PI/2}" xyz="0 0 0.041" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/tool_main.stl" />
                </geometry>
            </collision>
        </link>

        <!-- Link 4: Tool Wrist Link -->
        <link name="${prefix}_tool_wrist_link">
            <visual>
                <origin rpy="0 0 ${PI/2}" xyz="0 0 -0.0091" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/tool_wrist_link.stl" />
                </geometry>
            </visual>
            <collision>
                <origin rpy="0 0 ${PI/2}" xyz="0 0 -0.0091" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/tool_wrist_link.stl" />
                </geometry>
            </collision>
        </link>

        <!-- Link 4-1: Tool Wrist Shaft Link -->
        <link name="${prefix}_tool_wrist_shaft_link">
            <visual>
                <origin rpy="${PI/2} 0 0" xyz="0 0.00401 0" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/tool_wrist_shaft_link.stl" />
                </geometry>
            </visual>
            <collision>
                <origin rpy="${PI/2} 0 0" xyz="0 0.00401 0" />
                <geometry>
                    <mesh filename="package://psm_description/meshes/Classic/tool_wrist_shaft_link.stl" />
                </geometry>
            </collision>
        </link>

        <!-- Joint 0: Fixed Joint: Parent Link to Link 0 -->
        <joint name="${prefix}_custom_fixed" type="fixed">
            <parent link="${parent_link}" />
            <child link="${prefix}_psm_base_link" />
            <origin rpy="${rpy}" xyz="${xyz}" />
        </joint>

        <!-- Joint 1: Outer Yaw Joint: Link 0 to Link 1 -->
        <joint name="${prefix}_outer_yaw" type="revolute">
            <parent link="${prefix}_psm_base_link" />
            <child link="${prefix}_outer_yaw_link" />
            <axis xyz="0 0 1" />
            <!-- <origin rpy="${PI/2} -${PI/2} 0" xyz="0.0 -0.369 0.0"/> -->
            <origin rpy="0 -${PI/2} ${PI/2}" xyz="0.0 0.0 0.0" />
            <limit lower="-${PI/2}" upper="${PI/2}" velocity=".4" effort="1000" />
        </joint>

        <!-- Note: I can not put visual link here as it's parallel -->
        <!-- mechanism, so the outer_pitch_link does not have visual -->
        <!-- link, all visual links mimic outer_pitch value -->

        <!-- Joint 2: Outer Pitch Joint: Link 1 to Link 2 -->
        <joint name="${prefix}_pitch" type="revolute">
            <parent link="${prefix}_outer_yaw_link"/>
            <child link="${prefix}_outer_pitch_link"/>
            <axis xyz="0 0 1"/>
            <origin rpy="-${PI/2} -${PI/2} 0" xyz="0 0 0"/>
            <limit lower="-${PI/4}" upper="${PI/4}" velocity=".4" effort="1000"/>
        </joint>

        <!-- Joint 2-1: Outer Pitch 1 Joint: Link 1 to Link 2-1 -->
        <joint name="${prefix}_outer_pitch_1" type="continuous">
            <parent link="${prefix}_outer_yaw_link" />
            <child link="${prefix}_outer_pitch_back_link" />
            <axis xyz="0 0 1" />
            <origin rpy="-${PI/2} -${PI/2} 0" xyz="0 0.0295 0.5185" />
            <mimic joint="${prefix}_pitch" multiplier="1"/>
        </joint>

        <!-- Joint 2-2: Outer Pitch 2 Joint: Link 1 to Link 2-2 -->
        <joint name="${prefix}_outer_pitch_2" type="continuous">
            <parent link="${prefix}_outer_yaw_link" />
            <child link="${prefix}_outer_pitch_front_link" />
            <axis xyz="0 0 1" />
            <origin rpy="-${PI/2} -${PI/2} 0" xyz="0 0.0295 0.4285" />
            <mimic joint="${prefix}_pitch" multiplier="1" />
        </joint>

        <!-- Joint 2-3: Outer Pitch 3 Joint: Link 2-1 to Link 2-3 -->
        <joint name="${prefix}_outer_pitch_3" type="continuous">
            <parent link="${prefix}_outer_pitch_back_link" />
            <child link="${prefix}_outer_pitch_bottom_link" />
            <axis xyz="0 0 1" />
            <origin rpy="0 0 0" xyz="0.04178 0.15007 -0.0137" />
            <mimic joint="${prefix}_pitch" multiplier="-1" />
        </joint>

        <!-- Joint 2-4: Outer Pitch 4 Joint: Link 2-1 to Link 2-4 -->
        <joint name="${prefix}_outer_pitch_4" type="continuous">
            <parent link="${prefix}_outer_pitch_back_link" />
            <child link="${prefix}_outer_pitch_top_link" />
            <axis xyz="0 0 1" />
            <origin rpy="0 0 0" xyz="0.04209 0.18695 -0.02412" />
            <mimic joint="${prefix}_pitch" multiplier="-1" />
        </joint>

        <!-- Joint 2-5: Outer Pitch 5 Joint: Link 2-3 to Link 2-5 -->
        <joint name="${prefix}_outer_pitch_5" type="continuous">
            <parent link="${prefix}_outer_pitch_bottom_link" />
            <child link="${prefix}_outer_insertion_link" />
            <axis xyz="0 0 1" />
            <origin rpy="0 0 0" xyz="-0.520 0 -0.0155" />
            <mimic joint="${prefix}_pitch" multiplier="1" />
        </joint>

        <!-- Joint 3: Outer Insertion Joint: Link 2 to Link 3 -->
        <joint name="${prefix}_outer_insertion" type="prismatic">
            <parent link="${prefix}_outer_pitch_link" />
            <child link="${prefix}_tool_main_link" />
            <axis xyz="0 0 1" />
            <origin rpy="${PI/2} 0 0" xyz="0 0.4318 0" />
            <limit lower="0" upper="0.240" velocity=".4" effort="1000" />
        </joint>

        <!-- Joint 4: Outer Roll Joint: Link 3 to Link 4 -->
        <joint name="${prefix}_outer_roll" type="revolute">
            <parent link="${prefix}_tool_main_link" />
            <child link="${prefix}_tool_wrist_link" />
            <axis xyz="0 0 1" />
            <origin rpy="0 0 0" xyz="0 0 0.4162" />
            <limit lower="-4.53786" upper="4.53786" velocity=".4" effort="1000" />
        </joint>

        <!-- Joint 4-1: Outer Roll Shaft Joint: Link 4 to Link 4-1 -->
        <joint name="${prefix}_outer_roll_shaft" type="fixed">
            <parent link="${prefix}_tool_wrist_link" />
            <child link="${prefix}_tool_wrist_shaft_link" />
            <axis xyz="0 0 1" />
            <origin rpy="0 0 0" xyz="0 0 0.0" />
        </joint>

    </xacro:macro>
</robot>