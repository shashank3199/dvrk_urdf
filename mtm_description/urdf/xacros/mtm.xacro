<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">

    <!-- Mathematical Constants -->
    <xacro:include filename="$(find mtm_description)/urdf/xacros/common.xacro" />

    <!--
    ================================================================================================ -->
    <!-- Macro for the da Vinci Master Console -->
    <xacro:macro name="master_console" params="prefix parent_link xyz rpy">
        <link name="${prefix}_master_base_link" />

        <joint name="base_fixed" type="fixed">
            <parent link="${parent_link}" />
            <child link="${prefix}_master_base_link" />
            <origin rpy="${rpy}" xyz="${xyz}" />
        </joint>

        <xacro:left_mtm prefix="${prefix}" parent_link="${prefix}_master_base_link" />
        <xacro:right_mtm prefix="${prefix}" parent_link="${prefix}_master_base_link" />
    </xacro:macro>

    <!--
    ================================================================================================ -->
    <!-- Macro for da Vinci Master Tool Manipulator (MTM) -->
    <xacro:macro name="mtm" params="prefix parent_link xyz rpy">

        <!-- Link 0: Top Panel Link -->
        <link name="${prefix}_top_panel">
            <visual>
                <origin rpy="0 0 0" xyz="0 0 0.19037" />
                <geometry>
                    <mesh filename="package://mtm_description/meshes/TopPanel.dae" />
                </geometry>
            </visual>
            <collision>
                <origin rpy="0 0 0" xyz="0 0 0.19037" />
                <geometry>
                    <mesh filename="package://mtm_description/meshes/TopPanel.stl" />
                </geometry>
            </collision>
            <inertial>
                <origin xyz="0 0 0" rpy="0 0 0" />
                <mass value=".9" />
                <inertia ixx="9.0" ixy="0.0" ixz="0.0" iyy="9.0" iyz="0.0" izz="9.0" />
            </inertial>
        </link>

        <!-- Link 1: Outer Yaw Link -->
        <link name="${prefix}_outer_yaw_link">
            <visual>
                <origin rpy="0 0 0" xyz="0.025 0 0.19037" />
                <geometry>
                    <mesh filename="package://mtm_description/meshes/OutPitch_Shoulder.dae" />
                </geometry>
            </visual>
            <collision>
                <origin rpy="0 0 0" xyz="0.025 0 0.19037" />
                <geometry>
                    <mesh filename="package://mtm_description/meshes/OutPitch_Shoulder.stl" />
                </geometry>
            </collision>
            <inertial>
                <mass value="1" />
                <inertia ixx="10.0" ixy="0.0" ixz="0.0" iyy="10.0" iyz="0.0" izz="10.0" />
            </inertial>
        </link>

        <!-- Link 2: Back Parallel Link -->
        <link name="${prefix}_back_parallel_link">
            <visual>
                <geometry>
                    <mesh filename="package://mtm_description/meshes/ArmParallel.dae" />
                </geometry>
            </visual>
            <collision>
                <geometry>
                    <mesh filename="package://mtm_description/meshes/ArmParallel.stl" />
                </geometry>
            </collision>
            <inertial>
                <mass value=".9" />
                <inertia ixx="9.0" ixy="0.0" ixz="0.0" iyy="9.0" iyz="0.0" izz="9.0" />
            </inertial>
        </link>

        <!-- Link 3: Top Parallel Link -->
        <link name="${prefix}_top_parallel_link">
            <visual>
                <origin rpy="0 0 ${-PI/2}" xyz="0 0 0.065" />
                <geometry>
                    <mesh filename="package://mtm_description/meshes/ArmParallel1.dae" />
                </geometry>
            </visual>
            <collision>
                <origin rpy="0 0 0" xyz="0 0 0" />
                <geometry>
                    <mesh filename="package://mtm_description/meshes/ArmParallel1.stl" />
                </geometry>
            </collision>
            <inertial>
                <mass value=".5" />
                <inertia ixx="5.0" ixy="0.0" ixz="0.0" iyy="5.0" iyz="0.0" izz="5.0" />
            </inertial>
        </link>

        <!-- Link 4: Bottom Parallel Link -->
        <link name="${prefix}_bottom_parallel_link">
            <visual>
                <geometry>
                    <mesh filename="package://mtm_description/meshes/BottomArm.dae" />
                </geometry>
            </visual>
            <collision>
                <geometry>
                    <mesh filename="package://mtm_description/meshes/BottomArm.stl" />
                </geometry>
            </collision>
            <inertial>
                <mass value="0.8" />
                <inertia ixx="0.1" ixy="0.0" ixz="0.0"
                    iyy="0.1" iyz="0.0"
                    izz="0.1" />
            </inertial>
        </link>

        <!-- Joint 0: Fixed to World: Parent Link to Link 0 -->
        <joint name="${prefix}_fixed" type="fixed">
            <parent link="${parent_link}" />
            <child link="${prefix}_top_panel" />
            <origin rpy="${rpy}" xyz="${xyz}" />
        </joint>

        <!-- Joint 1: Outer Yaw: Link 0 to Link 1 -->
        <joint name="${prefix}_outer_yaw" type="revolute">
            <parent link="${prefix}_top_panel" />
            <child link="${prefix}_outer_yaw_link" />
            <origin rpy="0 0 ${PI/2}" xyz="0 0 0" />
            <!--rotates
            about z axis-->
            <axis xyz="0 0 1" />
            <!--limit
            effort and velocity picked arbitrarily check-->
            <limit effort="50.0" lower="${-75/180*PI}" upper="${PI/4}" velocity="2" />
            <joint_properties damping="1.0" friction="0.0" />
        </joint>

        <!-- Joint 2: Shoulder Pitch: Link 1 to Link 2 -->
        <joint name="${prefix}_shoulder_pitch" type="revolute">
            <parent link="${prefix}_outer_yaw_link" />
            <child link="${prefix}_back_parallel_link" />  <!-- xyz= 0 0 -.19037-->
            <origin rpy="${-PI/2} ${-PI/2} 0" xyz="0 0 0" />
            <axis xyz="0 0 1" />
            <!--limit
            effort and velocity picked arbitrarily check-->
            <limit effort="100.0" lower="${-PI/4}" upper="${PI/4}" velocity="10" />
            <joint_properties damping="1.0" friction="0.0" />
        </joint>

        <!-- Joint 3: Shoulder Pitch Parallel: Link 1 to Link 3 -->
        <joint name="${prefix}_shoulder_pitch_parallel" type="revolute">
            <parent link="${prefix}_outer_yaw_link" />
            <child link="${prefix}_top_parallel_link" />
            <origin rpy="${-PI/2} ${-PI/2} 0" xyz="0 0 0" />
            <!--rotates
            about x axis-->
            <axis xyz="0 0 1" />
            <!--limit
            effort and velocity picked arbitrarily check-->
            <limit effort="100.0" lower="${-PI/2}" upper="${PI/2}" velocity="10" />
            <joint_properties damping="1.0" friction="0.0" />
            <mimic joint="${prefix}_shoulder_pitch" multiplier="1" />
        </joint>

        <!-- Joint 4: Elbow Pitch: Link 2 to Link 4 -->
        <joint name="${prefix}_elbow_pitch" type="revolute">
            <parent link="${prefix}_back_parallel_link" />
            <child link="${prefix}_bottom_parallel_link" />  <!-- xyz= -->
            <origin rpy="0 0 ${PI/2}" xyz="-0.2794 0 0" />
            <axis xyz="0 0 1" />
            <!--limit
            effort and velocity picked arbitrarily check-->
            <limit effort="100.0" lower="${-PI/4}" upper="${PI/4}" velocity="10" />
            <joint_properties damping="1.0" friction="0.0" />
        </joint>

        <transmission name="tran1">
            <type>transmission_interface/SimpleTransmission</type>
            <joint name="${prefix}_outer_yaw" />
            <actuator name="motor1">
                <hardwareInterface>EffortJointInterface</hardwareInterface>
                <mechanicalReduction>1</mechanicalReduction>
            </actuator>
        </transmission>
        <transmission name="tran2">
            <type>transmission_interface/SimpleTransmission</type>
            <joint name="${prefix}_shoulder_pitch" />
            <actuator name="motor2">
                <hardwareInterface>EffortJointInterface</hardwareInterface>
                <mechanicalReduction>1</mechanicalReduction>
            </actuator>
        </transmission>
        <transmission name="tran3">
            <type>transmission_interface/SimpleTransmission</type>
            <joint name="${prefix}_elbow_pitch" />
            <actuator name="motor3">
                <hardwareInterface>EffortJointInterface</hardwareInterface>
                <mechanicalReduction>1</mechanicalReduction>
            </actuator>
        </transmission>
        <gazebo>
            <plugin name="gazebo_ros_control" filename="libgazebo_ros_control.so">
                <robotNamespace>/mtm</robotNamespace>
            </plugin>
        </gazebo>

        <gazebo>
            <plugin name="force_torque_sensor" filename="libgazebo_ros_f3d.so">
                <bodyName>${prefix}_bottom_parallel_link</bodyName>
                <frameName>${prefix}_bottom_parallel_link</frameName>
                <topicName>/force_torque_feedback</topicName>
                <alwaysOn>true</alwaysOn>
                <updateRate>100.0</updateRate>
            </plugin>
        </gazebo>

    </xacro:macro>

    <!--
    ================================================================================================ -->
    <!-- Macro for dVRK MTM Platform Right -->
    <xacro:macro name="mtm_platform_right" params="prefix">

        <!-- Link 5: Wrist Platform Link -->
        <link name="${prefix}_wrist_platform_link">
            <visual>
                <geometry>
                    <mesh filename="package://mtm_description/meshes/WristPlatform.dae" />
                </geometry>
            </visual>
            <collision>
                <geometry>
                    <mesh filename="package://mtm_description/meshes/WristPlatform.stl" />
                </geometry>
            </collision>
            <inertial>
                <mass value="0.4" />
                <inertia ixx="0.1" ixy="0.0" ixz="0.0" iyy="0.1" iyz="0.0" izz="0.1" />
            </inertial>
        </link>

        <!-- Link 6: Wrist Pitch Link -->
        <link name="${prefix}_wrist_pitch_link">
            <visual>        <!-- defined from CAD file (increased in the y dir by .005-->
                <geometry>
                    <mesh filename="package://mtm_description/meshes/WristPitch.dae" />
                </geometry>
            </visual>
            <collision>        <!-- defined from CAD file (increased in the y dir by .005-->
                <geometry>
                    <mesh filename="package://mtm_description/meshes/WristPitch.stl" />
                </geometry>
            </collision>
            <inertial>
                <mass value="0.2" />
                <inertia ixx="0.1" ixy="0.0" ixz="0.0" iyy="0.1" iyz="0.0" izz="0.1" />
            </inertial>
        </link>

        <!-- Link 7: Wrist Yaw Link -->
        <link name="${prefix}_wrist_yaw_link">
            <visual>
                <geometry>
                    <mesh filename="package://mtm_description/meshes/WristYaw.dae" />
                </geometry>
            </visual>
            <collision>
                <geometry>
                    <mesh filename="package://mtm_description/meshes/WristYaw.stl" />
                </geometry>
            </collision>
            <inertial>
                <mass value="0.2" />
                <inertia ixx="0.1" ixy="0.0" ixz="0.0" iyy="0.1" iyz="0.0" izz="0.1" />
            </inertial>
        </link>

        <!-- Link 8: Wrist Roll Link -->
        <link name="${prefix}_wrist_roll_link">
            <visual>
                <origin rpy="${PI} 0 0" xyz="0 0 0.039" />
                <geometry>
                    <mesh filename="package://mtm_description/meshes/WristRoll.dae" />
                </geometry>
            </visual>
            <collision>
                <origin rpy="${PI} 0 0" xyz="0 0 0.039" />
                <geometry>
                    <mesh filename="package://mtm_description/meshes/WristRoll.stl" />
                </geometry>
            </collision>
            <inertial>
                <mass value="0.1" />
                <inertia ixx="0.1" ixy="0.0" ixz="0.0" iyy="0.1" iyz="0.0" izz="0.1" />
            </inertial>
        </link>

        <!-- Joint 5: Wrist Platform Joint: Link 4 to Link 5 -->
        <joint name="${prefix}_wrist_platform" type="revolute">
            <parent link="${prefix}_bottom_parallel_link" />
            <child link="${prefix}_wrist_platform_link" />
            <origin rpy="${PI/2} 0 0" xyz="-0.3645 -0.1506 0.0" />
            <!--rotates
            about z axis-->
            <axis xyz="0 0 1" />
            <!--limit
            effort and velocity picked arbitrarily check-->
            <limit effort="100.0" lower="${-60/180*PI}" upper="${245/180*PI}" velocity="10" />
            <joint_properties damping="1.0" friction="0.0" />
        </joint>

        <!-- Joint 6: Wrist Pitch Joint: Link 5 to Link 6 -->
        <joint name="${prefix}_wrist_pitch" type="revolute">
            <parent link="${prefix}_wrist_platform_link" />
            <child link="${prefix}_wrist_pitch_link" />
            <origin rpy="${-PI/2} 0 0" xyz="0 0 0" />
            <axis xyz="0 0 1" />
            <!--limit
            effort and velocity picked arbitrarily check-->
            <limit effort="100.0" lower="${-PI/2}" upper="${PI}" velocity="10" />
            <joint_properties damping="1.0" friction="0.0" />
        </joint>

        <!-- Joint 7: Wrist Yaw Joint: Link 6 to Link 7 -->
        <joint name="${prefix}_wrist_yaw" type="revolute">
            <parent link="${prefix}_wrist_pitch_link" />
            <child link="${prefix}_wrist_yaw_link" />    <!--  defined from CAD file-->
            <origin rpy="${PI/2} ${-PI/2} 0" xyz="0 0 0" />
            <!--rotates
            about z axis-->
            <axis xyz="0 0 1" />
            <!--limit
            effort and velocity picked arbitrarily check-->
            <limit effort="100.0" lower="${-PI/4}" upper="${PI/4}" velocity="10" />
            <joint_properties damping="1.0" friction="0.0" />
        </joint>

        <!-- Joint 8: Wrist Roll Joint: Link 7 to Link 8 -->
        <joint name="${prefix}_wrist_roll" type="revolute">
            <parent link="${prefix}_wrist_yaw_link" />
            <child link="${prefix}_wrist_roll_link" />  <!-- -.039 & .055 defined from CAD file-->
            <!-- <origin rpy="${-PI/2} ${PI/2} 0" xyz="0 -.039 0"/> -->
            <origin rpy="0 ${-PI/2} ${PI/2}" xyz="0 0 0" />
            <axis xyz="0 0 1" />
            <!--limit
            effort and velocity picked arbitrarily check-->
            <limit effort="100.0" lower="${-1.5*PI}" upper="${1.5*PI}" velocity="10" />
            <joint_properties damping="1.0" friction="0.0" />
        </joint>

        <transmission name="tran4">
            <type>transmission_interface/SimpleTransmission</type>
            <joint name="${prefix}_wrist_platform" />
            <actuator name="motor4">
                <hardwareInterface>EffortJointInterface</hardwareInterface>
                <mechanicalReduction>1</mechanicalReduction>
            </actuator>
        </transmission>
        <transmission name="tran5">
            <type>transmission_interface/SimpleTransmission</type>
            <joint name="${prefix}_wrist_pitch" />
            <actuator name="motor5">
                <hardwareInterface>EffortJointInterface</hardwareInterface>
                <mechanicalReduction>1</mechanicalReduction>
            </actuator>
        </transmission>
        <transmission name="tran6">
            <type>transmission_interface/SimpleTransmission</type>
            <joint name="${prefix}_wrist_yaw" />
            <actuator name="motor6">
                <hardwareInterface>EffortJointInterface</hardwareInterface>
                <mechanicalReduction>1</mechanicalReduction>
            </actuator>
        </transmission>
        <transmission name="tran7">
            <type>transmission_interface/SimpleTransmission</type>
            <joint name="${prefix}_wrist_roll" />
            <actuator name="motor7">
                <hardwareInterface>EffortJointInterface</hardwareInterface>
                <mechanicalReduction>1</mechanicalReduction>
            </actuator>
        </transmission>

    </xacro:macro>

    <!--
    ================================================================================================ -->
    <!-- Macro for dVRK MTM Platform Left -->
    <xacro:macro name="mtm_platform_left" params="prefix">

        <!-- Link 9: Wrist Platform Link (with Origins) -->
        <link name="${prefix}_wrist_platform_link">
            <visual>
                <origin rpy="0 0 ${PI}" xyz="0.0 0.0 0.0" />
                <geometry>
                    <mesh filename="package://mtm_description/meshes/WristPlatform.dae" />
                </geometry>
            </visual>
            <collision>
                <origin rpy="0 0 ${PI}" xyz="0.0 0.0 0.0" />
                <geometry>
                    <mesh filename="package://mtm_description/meshes/WristPlatform.stl" />
                </geometry>
            </collision>
            <inertial>
                <mass value="0.4" />
                <inertia ixx="0.1" ixy="0.0" ixz="0.0" iyy="0.1" iyz="0.0" izz="0.1" />
            </inertial>
        </link>

        <!-- Link 10: Wrist Pitch Link (with Origins) -->
        <link name="${prefix}_wrist_pitch_link">
            <visual>        <!-- defined from CAD file (increased in the y dir by .005-->
                <origin rpy="0 ${PI} 0" xyz="0.0 0.0 0.0" />
                <geometry>
                    <mesh filename="package://mtm_description/meshes/WristPitch.dae" />
                </geometry>
            </visual>
            <collision>        <!-- defined from CAD file (increased in the y dir by .005-->
                <origin rpy="0 ${PI} 0" xyz="0.0 0.0 0.0" />
                <geometry>
                    <mesh filename="package://mtm_description/meshes/WristPitch.stl" />
                </geometry>
            </collision>
            <inertial>
                <mass value="0.2" />
                <inertia ixx="0.1" ixy="0.0" ixz="0.0" iyy="0.1" iyz="0.0" izz="0.1" />
            </inertial>
        </link>

        <!-- Link 11: Wrist Yaw Link (with Origins) -->
        <link name="${prefix}_wrist_yaw_link">
            <visual>
                <geometry>
                    <mesh filename="package://mtm_description/meshes/WristYaw.dae" />
                </geometry>
            </visual>
            <collision>
                <geometry>
                    <mesh filename="package://mtm_description/meshes/WristYaw.stl" />
                </geometry>
            </collision>
            <inertial>
                <mass value="0.2" />
                <inertia ixx="0.1" ixy="0.0" ixz="0.0" iyy="0.1" iyz="0.0" izz="0.1" />
            </inertial>
        </link>

        <!-- Link 12: Wrist Roll Link (with Origins) -->
        <link name="${prefix}_wrist_roll_link">
            <visual>
                <origin rpy="${PI} 0 0" xyz="0 0 0.039" />
                <geometry>
                    <mesh filename="package://mtm_description/meshes/WristRoll.dae" />
                </geometry>
            </visual>
            <collision>
                <origin rpy="${PI} 0 0" xyz="0 0 0.039" />
                <geometry>
                    <mesh filename="package://mtm_description/meshes/WristRoll.stl" />
                </geometry>
            </collision>
            <inertial>
                <mass value="0.1" />
                <inertia ixx="0.1" ixy="0.0" ixz="0.0" iyy="0.1" iyz="0.0" izz="0.1" />
            </inertial>
        </link>

        <!-- Joint 9: Wrist Platform Joint: Link 4 to Link 5/9 -->
        <joint name="${prefix}_wrist_platform" type="revolute">
            <parent link="${prefix}_bottom_parallel_link" />
            <child link="${prefix}_wrist_platform_link" />
            <origin rpy="${PI/2} 0 0" xyz="-0.3645 -0.1506 0.0" />
            <!--rotates
            about z axis-->
            <axis xyz="0 0 1" />
            <!--limit
            effort and velocity picked arbitrarily check-->
            <limit effort="100.0" lower="${-60/180*PI}" upper="${245/180*PI}" velocity="10" />
            <joint_properties damping="1.0" friction="0.0" />
        </joint>

        <!-- Joint 10: Wrist Pitch Joint: Link 5/9 to Link 6/10 -->
        <joint name="${prefix}_wrist_pitch" type="revolute">
            <parent link="${prefix}_wrist_platform_link" />
            <child link="${prefix}_wrist_pitch_link" />
            <origin rpy="${-PI/2} 0 0" xyz="0 0 0" />
            <axis xyz="0 0 1" />
            <!--limit
            effort and velocity picked arbitrarily check-->
            <limit effort="100.0" lower="${-PI/2}" upper="${PI}" velocity="10" />
            <joint_properties damping="1.0" friction="0.0" />
        </joint>

        <!-- Joint 11: Wrist Yaw Joint: Link 6/10 to Link 7/11 -->
        <joint name="${prefix}_wrist_yaw" type="revolute">
            <parent link="${prefix}_wrist_pitch_link" />
            <child link="${prefix}_wrist_yaw_link" />    <!--  defined from CAD file-->
            <origin rpy="${PI/2} ${-PI/2} 0" xyz="0 0 0" />
            <!--rotates
            about z axis-->
            <axis xyz="0 0 1" />
            <!--limit
            effort and velocity picked arbitrarily check-->
            <limit effort="100.0" lower="${-PI/4}" upper="${PI/4}" velocity="10" />
            <joint_properties damping="1.0" friction="0.0" />
        </joint>

        <!-- Joint 12: Wrist Roll Joint: Link 7/11 to Link 8/12 -->
        <joint name="${prefix}_wrist_roll" type="revolute">
            <parent link="${prefix}_wrist_yaw_link" />
            <child link="${prefix}_wrist_roll_link" />  <!-- -.039 & .055 defined from CAD file-->
            <!-- <origin rpy="${-PI/2} ${PI/2} 0" xyz="0 -.039 0"/> -->
            <origin rpy="0 ${-PI/2} ${PI/2}" xyz="0 0 0" />
            <axis xyz="0 0 1" />
            <!--limit
            effort and velocity picked arbitrarily check-->
            <limit effort="100.0" lower="${-1.5*PI}" upper="${1.5*PI}" velocity="10" />
            <joint_properties damping="1.0" friction="0.0" />
        </joint>

        <transmission name="tran4">
            <type>transmission_interface/SimpleTransmission</type>
            <joint name="${prefix}_wrist_platform" />
            <actuator name="motor4">
                <hardwareInterface>EffortJointInterface</hardwareInterface>
                <mechanicalReduction>1</mechanicalReduction>
            </actuator>
        </transmission>
        <transmission name="tran5">
            <type>transmission_interface/SimpleTransmission</type>
            <joint name="${prefix}_wrist_pitch" />
            <actuator name="motor5">
                <hardwareInterface>EffortJointInterface</hardwareInterface>
                <mechanicalReduction>1</mechanicalReduction>
            </actuator>
        </transmission>
        <transmission name="tran6">
            <type>transmission_interface/SimpleTransmission</type>
            <joint name="${prefix}_wrist_yaw" />
            <actuator name="motor6">
                <hardwareInterface>EffortJointInterface</hardwareInterface>
                <mechanicalReduction>1</mechanicalReduction>
            </actuator>
        </transmission>
        <transmission name="tran7">
            <type>transmission_interface/SimpleTransmission</type>
            <joint name="${prefix}_wrist_roll" />
            <actuator name="motor7">
                <hardwareInterface>EffortJointInterface</hardwareInterface>
                <mechanicalReduction>1</mechanicalReduction>
            </actuator>
        </transmission>

    </xacro:macro>

    <!--
    ================================================================================================ -->
    <!-- Macros for Right MTM -->
    <xacro:macro name="mtm_right" params="prefix parent_link xyz rpy">
        <xacro:mtm
            prefix="${prefix}"
            parent_link="${parent_link}"
            xyz="${xyz}" rpy="${rpy}" />
        <xacro:mtm_platform_right prefix="${prefix}" />
    </xacro:macro>

    <!--
    ================================================================================================ -->
    <!-- Macros for Left MTM -->
    <xacro:macro name="mtm_left" params="prefix parent_link xyz rpy">
        <xacro:mtm
            prefix="${prefix}"
            parent_link="${parent_link}"
            xyz="${xyz}" rpy="${rpy}" />
        <xacro:mtm_platform_left prefix="${prefix}" />
    </xacro:macro>

</robot>